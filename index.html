<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta name="googlebot" content="noindex, nofollow">
    <title>Contabilita Dos Amigos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-primary: #000000;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #999999;
            --accent: #D8FF36;
            --accent-hover: #c4e830;
            --accent-text: #000000;
            --border: #333333;
            --border-light: #444444;
            --danger: #ff4444;
            --danger-hover: #cc0000;
            --positive: #D8FF36;
            --negative: #ff4444;
            --row-hover: rgba(255, 255, 255, 0.05);
        }

        body.light-mode {
            --bg-primary: #f0f2f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e8eaed;
            --text-primary: #1a1a1a;
            --text-secondary: #5f6368;
            --accent: #4a7a00;
            --accent-hover: #3d6600;
            --accent-text: #ffffff;
            --border: #dadce0;
            --border-light: #c4c7cc;
            --danger: #d93025;
            --danger-hover: #b3261e;
            --positive: #1e8e3e;
            --negative: #d93025;
            --row-hover: rgba(0, 0, 0, 0.03);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background 0.3s, color 0.3s;
        }

        /* ===== HEADER (always dark) ===== */
        .header {
            background: #000000;
            border-bottom: 1px solid #333;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: baseline;
            gap: 12px;
        }

        .logo-dos {
            font-family: 'Arial Black', 'Impact', sans-serif;
            font-size: 32px;
            font-weight: 900;
            color: #D8FF36;
            letter-spacing: 3px;
        }

        .logo-amigos {
            font-family: 'Arial Black', 'Impact', sans-serif;
            font-size: 32px;
            font-weight: 900;
            color: #ffffff;
            letter-spacing: 3px;
        }

        .header-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .sync-status {
            background: rgba(216, 255, 54, 0.15);
            padding: 8px 14px;
            border-radius: 6px;
            border: 1px solid #333;
            color: #D8FF36;
            font-size: 13px;
            white-space: nowrap;
        }

        .sync-status.saving {
            animation: pulse 1s infinite;
        }

        .sync-status.error {
            background: rgba(255, 68, 68, 0.2);
            border-color: #ff4444;
            color: #ff4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ===== BUTTONS ===== */
        .btn {
            background: var(--accent);
            color: var(--accent-text);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .btn-sm {
            padding: 6px 14px;
            font-size: 12px;
            border-radius: 6px;
        }

        .btn-danger {
            background: var(--danger);
            color: #fff;
        }

        .btn-danger:hover {
            background: var(--danger-hover);
        }

        .btn-header {
            background: rgba(216, 255, 54, 0.15);
            color: #D8FF36;
            border: 1px solid #555;
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-header:hover {
            background: rgba(216, 255, 54, 0.3);
        }

        .delete-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .delete-btn:hover {
            background: var(--danger-hover);
        }

        /* ===== CONTAINER ===== */
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* ===== CONTROLS BAR ===== */
        .controls-bar {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        /* ===== SECTIONS ===== */
        .section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            transition: background 0.3s, border-color 0.3s;
        }

        .section-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .section-header h2 {
            color: var(--accent);
            font-size: 1.4em;
            margin: 0;
        }

        .section-body {
            padding: 0;
        }

        /* ===== FILTERS ===== */
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-primary);
        }

        .filters input,
        .filters select {
            padding: 8px 10px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-light);
            border-radius: 6px;
            font-size: 13px;
            transition: background 0.3s, color 0.3s, border-color 0.3s;
        }

        .filters input:focus,
        .filters select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .filters label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            padding: 8px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: 6px;
            font-size: 13px;
            color: var(--text-primary);
        }

        .filters label input[type="checkbox"] {
            width: auto;
            padding: 0;
            background: none;
            border: none;
        }

        /* ===== PAGINATION ===== */
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-primary);
        }

        .pagination select {
            padding: 6px 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-light);
            border-radius: 6px;
            font-size: 13px;
        }

        .pagination span {
            color: var(--accent);
            font-size: 13px;
        }

        .pagination .label {
            color: var(--text-secondary);
            font-size: 13px;
        }

        /* ===== TABLES ===== */
        .table-wrap {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--bg-secondary);
            color: var(--accent);
            padding: 12px 10px;
            text-align: left;
            font-weight: bold;
            font-size: 13px;
            border-bottom: 2px solid var(--border);
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }

        th:hover {
            background: var(--bg-tertiary);
        }

        td {
            padding: 6px 8px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }

        tr:hover {
            background: var(--row-hover);
        }

        td input,
        td select {
            width: 100%;
            padding: 6px 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            font-size: 13px;
            transition: background 0.3s, color 0.3s, border-color 0.3s;
        }

        td input:focus,
        td select:focus {
            outline: none;
            border-color: var(--accent);
        }

        td input:read-only {
            background: var(--bg-primary);
            border-color: transparent;
            color: var(--text-secondary);
        }

        tfoot td {
            padding: 12px 10px;
            font-weight: bold;
            font-size: 1em;
            border-top: 2px solid var(--border);
        }

        /* ===== BADGES ===== */
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
        }

        .badge-green {
            background: rgba(0, 180, 0, 0.2);
            color: #4caf50;
        }

        .badge-yellow {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .badge-red {
            background: rgba(255, 68, 68, 0.15);
            color: #ff6b6b;
        }

        .badge-gray {
            background: rgba(150, 150, 150, 0.2);
            color: #999;
        }

        /* ===== TOTAL CARDS ===== */
        .total-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .total-card {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--border);
            transition: background 0.3s, border-color 0.3s;
        }

        .total-card h3 {
            color: var(--accent);
            margin-bottom: 12px;
            font-size: 1.3em;
        }

        .total-line {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
            font-size: 14px;
        }

        .total-line:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.2em;
            margin-top: 8px;
            padding-top: 12px;
            border-top: 2px solid var(--border);
        }

        .positive { color: var(--positive); }
        .negative { color: var(--negative); }

        /* ===== SALDO BOX ===== */
        .saldo-box {
            text-align: center;
            padding: 25px 20px;
        }

        .saldo-box .saldo-label {
            font-size: 1em;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .saldo-box .saldo-value {
            font-size: 2.2em;
            font-weight: bold;
        }

        .saldo-box .saldo-note {
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        /* ===== SPESE FUTURE TOTAL ===== */
        .spese-future-total {
            margin: 15px 20px 20px;
            padding: 12px 15px;
            background: rgba(255, 68, 68, 0.08);
            border: 2px solid var(--danger);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* ===== NOTE ===== */
        .note-bar {
            background: var(--bg-secondary);
            padding: 12px 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 13px;
            transition: background 0.3s, border-color 0.3s;
        }

        .note-bar strong {
            color: var(--accent);
        }

        /* ===== LOGIN (always dark) ===== */
        .login-screen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-screen.hidden { display: none; }

        .login-box {
            background: #1a1a1a;
            padding: 40px;
            border-radius: 20px;
            border: 1px solid #333;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-logo {
            margin-bottom: 25px;
        }

        .login-logo .logo-dos,
        .login-logo .logo-amigos {
            font-size: 36px;
        }

        .login-box h2 {
            color: #D8FF36;
            margin-bottom: 25px;
            font-size: 1.5em;
        }

        .login-box input {
            width: 100%;
            padding: 14px;
            margin-bottom: 12px;
            background: #2a2a2a;
            border: 2px solid #444;
            border-radius: 8px;
            color: white;
            font-size: 15px;
        }

        .login-box input:focus {
            border-color: #D8FF36;
            outline: none;
        }

        .login-box button {
            width: 100%;
            padding: 14px;
            background: #D8FF36;
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .login-box button:hover {
            background: #c4e830;
        }

        .login-error {
            color: #ff4444;
            margin-top: 12px;
            display: none;
        }

        .login-error.show { display: block; }

        /* ===== LOADING ===== */
        .loading {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 10px;
            border: 1px solid #333;
            display: none;
            z-index: 1000;
            color: #D8FF36;
            font-size: 18px;
        }

        .loading.active { display: block; }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 10px; text-align: center; }
            .header-right { justify-content: center; flex-wrap: wrap; }
            .logo-dos, .logo-amigos { font-size: 24px; }
            .container { padding: 10px; gap: 12px; }
            .total-grid { grid-template-columns: 1fr; }
            .controls-bar { justify-content: center; }
        }
    </style>
</head>

<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="login-logo">
                <span class="logo-dos">DOS</span>
                <span class="logo-amigos">AMIGOS</span>
            </div>
            <h2>Accesso Riservato</h2>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <input type="text" id="username" placeholder="Username" autocomplete="off" required>
                <input type="password" id="password" placeholder="Password" autocomplete="off" required>
                <button type="submit">Accedi</button>
            </form>
            <div class="login-error" id="loginError">Credenziali errate! Riprova.</div>
        </div>
    </div>

    <div class="loading" id="loading">Caricamento...</div>

    <!-- Header -->
    <div class="header">
        <div class="logo">
            <span class="logo-dos">DOS</span>
            <span class="logo-amigos">AMIGOS</span>
        </div>
        <div class="header-right">
            <button class="btn-header" onclick="toggleTheme()" id="themeToggle">Light Mode</button>
            <div class="sync-status" id="syncStatus">Sincronizzato</div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">

        <!-- Controls Bar -->
        <div class="controls-bar">
            <button class="btn" onclick="addLavoro()">+ Aggiungi Lavoro</button>
            <button class="btn" onclick="addMovimento()">+ Aggiungi Movimento</button>
            <button class="btn" onclick="exportToExcel()">Esporta Excel</button>
            <button class="btn" onclick="manualSave()">Salva Ora</button>
            <button class="btn" onclick="downloadBackup()">Download Backup</button>
            <button class="btn btn-danger" onclick="logout()">Logout</button>
        </div>

        <!-- ===== LAVORI ===== -->
        <div class="section">
            <div class="section-header">
                <h2>Lavori e Preventivi</h2>
                <span style="color: var(--text-secondary); font-size: 13px;">Tracker lavori - lo split Frank/Fox definisce la divisione per ogni voce</span>
            </div>

            <div class="filters">
                <input type="date" id="filterDateFrom" placeholder="Data da" onchange="applyFilters()">
                <input type="date" id="filterDateTo" placeholder="Data a" onchange="applyFilters()">
                <input type="text" id="filterCliente" placeholder="Cerca cliente..." oninput="applyFilters()">
                <input type="number" id="filterMinImporto" placeholder="Min EUR" onchange="applyFilters()">
                <input type="number" id="filterMaxImporto" placeholder="Max EUR" onchange="applyFilters()">
                <label>
                    <input type="checkbox" id="filterHideIncassati" onchange="applyFilters()">
                    Nascondi incassati
                </label>
            </div>

            <div class="pagination">
                <div style="display: flex; gap: 8px; align-items: center;">
                    <span class="label">Mostra:</span>
                    <select id="lavoriPerPagina" onchange="changeLavoriPerPagina()">
                        <option value="10">10</option>
                        <option value="20" selected>20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button onclick="prevPageLavori()" class="btn btn-sm">Prec</button>
                    <span id="lavoriPaginaInfo">Pagina 1 di 1</span>
                    <button onclick="nextPageLavori()" class="btn btn-sm">Succ</button>
                </div>
            </div>

            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th onclick="sortTable('data')">Data</th>
                            <th onclick="sortTable('cliente')">Cliente</th>
                            <th>Lavoro / Spesa</th>
                            <th onclick="sortTable('importoPrevisto')">Importo Previsto</th>
                            <th>Imp. Fisc. (67%)</th>
                            <th>Tasse Stim. (5%)</th>
                            <th onclick="sortTable('costi')">Costi</th>
                            <th>Frank / Fox</th>
                            <th>Soggetto</th>
                            <th>Stato Pagamento</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="lavoriBody"></tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" style="color: var(--accent);">TOTALI</td>
                            <td style="color: var(--accent);" id="totalPrevisto">-</td>
                            <td></td>
                            <td style="color: var(--negative);" id="totalTasse">-</td>
                            <td style="color: var(--negative);" id="totalCosti">-</td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- ===== MOVIMENTI BANCARI ===== -->
        <div class="section">
            <div class="section-header">
                <h2>Movimenti Bancari</h2>
                <span style="color: var(--text-secondary); font-size: 13px;">Solo movimenti reali del conto bancario</span>
            </div>

            <div class="pagination">
                <div style="display: flex; gap: 8px; align-items: center;">
                    <span class="label">Mostra:</span>
                    <select id="movimentiPerPagina" onchange="changeMovimentiPerPagina()">
                        <option value="10">10</option>
                        <option value="20" selected>20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button onclick="prevPageMovimenti()" class="btn btn-sm">Prec</button>
                    <span id="movimentiPaginaInfo">Pagina 1 di 1</span>
                    <button onclick="nextPageMovimenti()" class="btn btn-sm">Succ</button>
                </div>
            </div>

            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Tipo</th>
                            <th>Importo EUR</th>
                            <th>Soggetto</th>
                            <th>Destinatario</th>
                            <th>Lavoro Collegato</th>
                            <th>Causale</th>
                            <th>Note</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="movimentiBody"></tbody>
                    <tfoot>
                        <tr>
                            <td colspan="2" style="color: var(--accent);">TOTALI</td>
                            <td id="movTotaleEntrate" style="color: var(--positive);">-</td>
                            <td colspan="6"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- ===== CONTO BANCARIO ===== -->
        <div class="section">
            <div class="section-header">
                <h2>Saldo Conto Bancario</h2>
            </div>
            <div class="saldo-box">
                <div class="saldo-label">Saldo attuale calcolato dai movimenti</div>
                <div class="saldo-value" id="saldoAttuale">-</div>
                <div class="saldo-note">Entrate - Prelievi - Spese - Tasse</div>
            </div>
        </div>

        <!-- ===== PORTAFOGLIO SOCI ===== -->
        <div class="section">
            <div class="section-header">
                <h2>Situazione Soci</h2>
                <span style="color: var(--text-secondary); font-size: 13px;">Spettanza + Anticipi conteggiati - Prelevato = Puo' prelevare</span>
            </div>
            <div class="total-grid">
                <div class="total-card">
                    <h3>FRANK</h3>
                    <div id="frankTotals"></div>
                </div>
                <div class="total-card">
                    <h3>FOX</h3>
                    <div id="foxTotals"></div>
                </div>
            </div>
        </div>

        <!-- ===== SPESE FUTURE ===== -->
        <div class="section">
            <div class="section-header">
                <h2>Spese Future Pianificate</h2>
                <button class="btn btn-sm" onclick="addSpesaFutura()">+ Aggiungi Spesa</button>
            </div>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>Descrizione</th>
                            <th>Importo EUR</th>
                            <th>Data Prevista</th>
                            <th>Ricorrente</th>
                            <th>Frequenza</th>
                            <th>Note</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="speseFutureBody"></tbody>
                </table>
            </div>
            <div class="spese-future-total">
                <strong style="color: var(--danger);">Totale Spese Future:</strong>
                <span id="totaleSpeseFuture" style="font-size: 1.3em; color: var(--danger);">-</span>
            </div>
        </div>

        <!-- Note -->
        <div class="note-bar">
            <strong>Info:</strong> Lo split Frank/Fox e' definito nei Lavori. I movimenti bancari ereditano lo split dal lavoro collegato.
            Soggetto Frank/Fox su un costo = pagato di tasca. Le spese non conteggiate (\u23F3) non incidono sul calcolo.
        </div>
    </div>

    <script>
        // =============== CONFIGURATION ===============
        const API_URL = 'api.php';
        const TIPI_MOVIMENTO = ['Entrata', 'Prelievo Socio', 'Spesa', 'Tasse'];
        const SOGGETTI = ['Dos Amigos', 'Frank', 'Fox'];
        const ENTRATA_TYPES = ['Entrata'];
        const USCITA_BANK_TYPES = ['Prelievo Socio', 'Spesa', 'Tasse'];

        // =============== STATE ===============
        let data = getDefaultData();
        let sortField = null;
        let sortDirection = 'asc';
        let saveTimeout = null;
        let lavoriPage = 1, lavoriPerPage = 20;
        let movimentiPage = 1, movimentiPerPage = 20;
        let isDarkMode = true;

        function getDefaultData() {
            return {
                lavori: [],
                movimentiBancari: [],
                contoBancario: { saldoAttuale: 0 },
                speseFuture: [],
                nextId: 1
            };
        }

        // =============== AUTH ===============
        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'login', username, password })
                });
                const result = await response.json();
                if (result.success) {
                    document.getElementById('loginScreen').classList.add('hidden');
                    loadData();
                } else {
                    showLoginError();
                }
            } catch (error) {
                console.error('Errore login:', error);
                showLoginError();
            }
        }

        function showLoginError() {
            const el = document.getElementById('loginError');
            el.classList.add('show');
            document.getElementById('password').value = '';
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        async function checkAuth() {
            try {
                const r = await fetch(API_URL + '?action=check_auth');
                const result = await r.json();
                return result.authenticated;
            } catch { return false; }
        }

        async function logout() {
            if (confirm('Vuoi disconnetterti?')) {
                await fetch(API_URL + '?action=logout');
                location.reload();
            }
        }

        // =============== DATA I/O ===============
        async function loadData() {
            showLoading(true);
            try {
                const r = await fetch(API_URL + '?action=load');
                const result = await r.json();
                data = result.success ? migrateData(result.data || getDefaultData()) : getDefaultData();
                renderAll();
                updateSyncStatus('success', 'Dati caricati');
            } catch (error) {
                console.error('Errore caricamento:', error);
                data = getDefaultData();
                renderAll();
                updateSyncStatus('error', 'Errore caricamento');
            }
            showLoading(false);
        }

        async function saveData() {
            updateSyncStatus('saving', 'Salvataggio...');
            try {
                const r = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'save', data })
                });
                const result = await r.json();
                updateSyncStatus(result.success ? 'success' : 'error',
                    result.success ? 'Salvato' : 'Errore salvataggio');
            } catch (error) {
                console.error('Errore salvataggio:', error);
                updateSyncStatus('error', 'Errore connessione');
            }
        }

        function autoSave() {
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => saveData(), 1000);
        }

        function manualSave() {
            if (saveTimeout) clearTimeout(saveTimeout);
            saveData();
        }

        function migrateData(d) {
            if (!d.nextId) d.nextId = 1;

            // Migrate lavori
            if (d.lavori) {
                d.lavori.forEach(lav => {
                    if (!lav.id) lav.id = 'lav_' + d.nextId++;
                    // Rename incassato -> importoPrevisto
                    if (lav.incassato !== undefined && lav.importoPrevisto === undefined) {
                        lav.importoPrevisto = lav.incassato;
                        delete lav.incassato;
                    }
                    if (lav.percentualeFrank === undefined) lav.percentualeFrank = 50;
                    if (lav.pagatoDa !== undefined) delete lav.pagatoDa;
                });
            } else {
                d.lavori = [];
            }

            // Migrate movimenti
            if (d.movimentiBancari) {
                d.movimentiBancari.forEach(mov => {
                    if (!mov.id) mov.id = 'mov_' + d.nextId++;
                    if (!mov.soggetto) mov.soggetto = mov.destinatario || 'Dos Amigos';
                    if (mov.lavoroCollegato === undefined) mov.lavoroCollegato = '';
                    if (mov.percentualeFrank === undefined) mov.percentualeFrank = 50;
                    // Migrate old tipo names
                    if (mov.tipo === 'Bonifico in entrata' || mov.tipo === 'Deposito') mov.tipo = 'Entrata';
                    if (mov.tipo === 'Bonifico in uscita' || mov.tipo === 'Prelievo') mov.tipo = 'Prelievo Socio';
                });
            } else {
                d.movimentiBancari = [];
            }

            if (!d.speseFuture) d.speseFuture = [];
            if (!d.contoBancario) d.contoBancario = { saldoAttuale: 0 };

            return d;
        }

        function generateId(prefix) {
            return prefix + '_' + data.nextId++;
        }

        // =============== RENDER ALL ===============
        function renderAll() {
            renderLavori();
            renderMovimenti();
            calculateBankBalance();
            calculatePortafoglio();
            renderSpeseFuture();
        }

        // =============== LAVORI ===============
        function addLavoro() {
            data.lavori.push({
                id: generateId('lav'),
                data: new Date().toISOString().split('T')[0],
                cliente: '',
                lavoro: '',
                importoPrevisto: 0,
                costi: 0,
                soggetto: 'Dos Amigos',
                percentualeFrank: 50,
                conteggiato: true
            });
            autoSave();
            renderAll();
        }

        function updateLavoro(id, field, value) {
            const lav = data.lavori.find(l => l.id === id);
            if (lav) {
                lav[field] = value;
                autoSave();
                renderAll();
            }
        }

        function deleteLavoro(id) {
            if (confirm('Eliminare questo lavoro?')) {
                data.lavori = data.lavori.filter(l => l.id !== id);
                autoSave();
                renderAll();
            }
        }

        function calculateRow(row) {
            const importo = parseFloat(row.importoPrevisto) || 0;
            const costi = parseFloat(row.costi) || 0;
            const imponibile = importo * 0.67;
            const tasse = imponibile * 0.05;
            return { imponibile, tasse };
        }

        function getLavoroStato(lavoro) {
            const previsto = parseFloat(lavoro.importoPrevisto) || 0;
            let incassatoReale = 0;

            data.movimentiBancari.forEach(mov => {
                if (mov.lavoroCollegato === lavoro.id && ENTRATA_TYPES.includes(mov.tipo)) {
                    incassatoReale += Math.abs(parseFloat(mov.importo) || 0);
                }
            });

            if (previsto === 0 && (parseFloat(lavoro.costi) || 0) > 0) {
                return { stato: 'Solo costi', classe: 'badge-gray', reale: incassatoReale };
            }
            if (previsto === 0) {
                return { stato: '-', classe: 'badge-gray', reale: 0 };
            }
            if (incassatoReale === 0) {
                return { stato: 'Da incassare', classe: 'badge-red', reale: 0 };
            }
            if (incassatoReale < previsto) {
                return { stato: 'Parziale', classe: 'badge-yellow', reale: incassatoReale };
            }
            return { stato: 'Incassato', classe: 'badge-green', reale: incassatoReale };
        }

        function buildSplitCell(row) {
            const pctF = parseFloat(row.percentualeFrank) || 50;
            const pctX = Math.round((100 - pctF) * 100) / 100;
            return `<div style="display:flex;align-items:center;gap:2px;white-space:nowrap;">
                <input type="number" min="0" max="100" step="0.01" value="${pctF}" onchange="updateLavoro('${row.id}', 'percentualeFrank', parseFloat(this.value) || 50)" style="width:50px;text-align:center;">
                <span style="color:var(--text-secondary);">/</span>
                <input type="number" value="${pctX}" onchange="updateLavoro('${row.id}', 'percentualeFrank', Math.round((100 - (parseFloat(this.value) || 50)) * 100) / 100)" style="width:50px;text-align:center;">
            </div>`;
        }

        function buildSoggettoCell(row) {
            const costi = parseFloat(row.costi) || 0;
            const sogg = row.soggetto || 'Dos Amigos';
            const isDiTasca = costi > 0 && (sogg === 'Frank' || sogg === 'Fox');
            const conteggiato = row.conteggiato !== false;
            let html = `<select onchange="updateLavoro('${row.id}', 'soggetto', this.value)">
                ${SOGGETTI.map(s => `<option value="${s}" ${sogg === s ? 'selected' : ''}>${s}</option>`).join('')}
            </select>`;
            if (isDiTasca) {
                html += `<label style="display:flex;align-items:center;gap:4px;margin-top:4px;font-size:11px;color:var(--text-secondary);cursor:pointer;">
                    <input type="checkbox" ${conteggiato ? 'checked' : ''} onchange="updateLavoro('${row.id}', 'conteggiato', this.checked)"> Conteggiato
                </label>`;
            }
            return html;
        }

        function renderLavori() {
            const tbody = document.getElementById('lavoriBody');
            tbody.innerHTML = '';

            const filtered = getFilteredLavori();
            let totalPrevisto = 0, totalTasse = 0, totalCosti = 0;

            // Totali su TUTTI i lavori (non paginati)
            data.lavori.forEach(row => {
                totalPrevisto += parseFloat(row.importoPrevisto) || 0;
                totalCosti += parseFloat(row.costi) || 0;
                const calc = calculateRow(row);
                totalTasse += calc.tasse;
            });

            // Paginazione
            const totalPages = Math.max(1, Math.ceil(filtered.length / lavoriPerPage));
            if (lavoriPage > totalPages) lavoriPage = totalPages;
            const start = (lavoriPage - 1) * lavoriPerPage;
            const paginated = filtered.slice(start, start + lavoriPerPage);
            document.getElementById('lavoriPaginaInfo').textContent =
                `Pagina ${lavoriPage} di ${totalPages} (${filtered.length} record)`;

            paginated.forEach(row => {
                const calc = calculateRow(row);
                const stato = getLavoroStato(row);
                const tr = document.createElement('tr');

                let statoHtml = `<span class="badge ${stato.classe}">${stato.stato}</span>`;
                if (stato.reale > 0) {
                    const prev = parseFloat(row.importoPrevisto) || 0;
                    statoHtml += `<br><small style="color: var(--text-secondary);">${formatEuro(stato.reale)} / ${formatEuro(prev)}</small>`;
                }

                tr.innerHTML = `
                    <td><input type="date" value="${row.data}" onchange="updateLavoro('${row.id}', 'data', this.value)"></td>
                    <td><input type="text" value="${row.cliente}" onchange="updateLavoro('${row.id}', 'cliente', this.value)"></td>
                    <td><input type="text" value="${row.lavoro}" onchange="updateLavoro('${row.id}', 'lavoro', this.value)"></td>
                    <td><input type="number" step="0.01" value="${row.importoPrevisto}" onchange="updateLavoro('${row.id}', 'importoPrevisto', this.value)"></td>
                    <td><input type="text" value="${calc.imponibile.toFixed(2)}" readonly></td>
                    <td><input type="text" value="${calc.tasse.toFixed(2)}" readonly></td>
                    <td><input type="number" step="0.01" value="${row.costi}" onchange="updateLavoro('${row.id}', 'costi', this.value)"></td>
                    <td>${buildSplitCell(row)}</td>
                    <td>${buildSoggettoCell(row)}</td>
                    <td style="text-align: center;">${statoHtml}</td>
                    <td><button class="delete-btn" onclick="deleteLavoro('${row.id}')">Elimina</button></td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('totalPrevisto').textContent = formatEuro(totalPrevisto);
            document.getElementById('totalTasse').textContent = formatEuro(totalTasse);
            document.getElementById('totalCosti').textContent = formatEuro(totalCosti);
        }

        function getFilteredLavori() {
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;
            const cliente = document.getElementById('filterCliente').value.toLowerCase();
            const minImp = parseFloat(document.getElementById('filterMinImporto').value);
            const maxImp = parseFloat(document.getElementById('filterMaxImporto').value);
            const hideIncassati = document.getElementById('filterHideIncassati').checked;

            return data.lavori.filter(row => {
                if (dateFrom && row.data < dateFrom) return false;
                if (dateTo && row.data > dateTo) return false;
                if (cliente && !(row.cliente || '').toLowerCase().includes(cliente)) return false;
                const imp = parseFloat(row.importoPrevisto) || 0;
                if (!isNaN(minImp) && imp < minImp) return false;
                if (!isNaN(maxImp) && imp > maxImp) return false;
                if (hideIncassati) {
                    const stato = getLavoroStato(row);
                    if (stato.stato === 'Incassato') return false;
                }
                return true;
            });
        }

        function applyFilters() {
            lavoriPage = 1;
            renderLavori();
        }

        function sortTable(field) {
            if (sortField === field) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortDirection = 'asc';
            }
            data.lavori.sort((a, b) => {
                let aVal = a[field], bVal = b[field];
                if (field === 'importoPrevisto' || field === 'costi') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                }
                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            autoSave();
            renderLavori();
        }

        // Pagination - Lavori
        function changeLavoriPerPagina() {
            lavoriPerPage = parseInt(document.getElementById('lavoriPerPagina').value);
            lavoriPage = 1;
            renderLavori();
        }
        function prevPageLavori() { if (lavoriPage > 1) { lavoriPage--; renderLavori(); } }
        function nextPageLavori() {
            const total = Math.ceil(getFilteredLavori().length / lavoriPerPage);
            if (lavoriPage < total) { lavoriPage++; renderLavori(); }
        }

        // =============== MOVIMENTI BANCARI ===============
        function addMovimento() {
            data.movimentiBancari.push({
                id: generateId('mov'),
                data: new Date().toISOString().split('T')[0],
                tipo: 'Entrata',
                importo: 0,
                soggetto: 'Dos Amigos',
                destinatario: 'Frank',
                lavoroCollegato: '',
                causale: '',
                note: ''
            });
            autoSave();
            renderAll();
        }

        function updateMovimento(id, field, value) {
            const mov = data.movimentiBancari.find(m => m.id === id);
            if (mov) {
                mov[field] = value;
                // When linking to a lavoro, auto-fill soggetto
                if (field === 'lavoroCollegato' && value) {
                    const lav = data.lavori.find(l => l.id === value);
                    if (lav) mov.soggetto = lav.soggetto;
                }
                autoSave();
                renderAll();
            }
        }

        function deleteMovimento(id) {
            if (confirm('Eliminare questo movimento?')) {
                data.movimentiBancari = data.movimentiBancari.filter(m => m.id !== id);
                autoSave();
                renderAll();
            }
        }

        function renderMovimenti() {
            const tbody = document.getElementById('movimentiBody');
            tbody.innerHTML = '';

            const total = data.movimentiBancari.length;
            const totalPages = Math.max(1, Math.ceil(total / movimentiPerPage));
            if (movimentiPage > totalPages) movimentiPage = totalPages;
            const start = (movimentiPage - 1) * movimentiPerPage;
            const paginated = data.movimentiBancari.slice(start, start + movimentiPerPage);

            document.getElementById('movimentiPaginaInfo').textContent =
                `Pagina ${movimentiPage} di ${totalPages} (${total} record)`;

            // Lavori options for dropdown
            const lavoriOpts = '<option value="">-- Nessuno --</option>' +
                data.lavori.map(l => {
                    const label = `${l.cliente || 'N/D'} - ${l.lavoro || 'N/D'}`;
                    return `<option value="${l.id}">${label}</option>`;
                }).join('');

            let totEntrate = 0, totUscite = 0;
            data.movimentiBancari.forEach(mov => {
                const imp = Math.abs(parseFloat(mov.importo) || 0);
                if (ENTRATA_TYPES.includes(mov.tipo)) totEntrate += imp;
                if (USCITA_BANK_TYPES.includes(mov.tipo)) totUscite += imp;
            });

            paginated.forEach(mov => {
                const tr = document.createElement('tr');
                const needsDest = mov.tipo === 'Prelievo Socio';
                const needsSogg = mov.tipo !== 'Prelievo Socio';

                // Build lavori select with correct selected option
                let lavSelect = '<option value="">-- Nessuno --</option>';
                data.lavori.forEach(l => {
                    const label = `${l.cliente || 'N/D'} - ${l.lavoro || 'N/D'}`;
                    const sel = l.id === mov.lavoroCollegato ? 'selected' : '';
                    lavSelect += `<option value="${l.id}" ${sel}>${label}</option>`;
                });

                tr.innerHTML = `
                    <td><input type="date" value="${mov.data}" onchange="updateMovimento('${mov.id}', 'data', this.value)"></td>
                    <td>
                        <select onchange="updateMovimento('${mov.id}', 'tipo', this.value)">
                            ${TIPI_MOVIMENTO.map(t => `<option value="${t}" ${mov.tipo === t ? 'selected' : ''}>${t}</option>`).join('')}
                        </select>
                    </td>
                    <td><input type="number" step="0.01" value="${mov.importo}" onchange="updateMovimento('${mov.id}', 'importo', this.value)"></td>
                    <td>
                        <select onchange="updateMovimento('${mov.id}', 'soggetto', this.value)" ${!needsSogg ? 'disabled style="opacity:0.4"' : ''}>
                            ${SOGGETTI.map(s => `<option value="${s}" ${mov.soggetto === s ? 'selected' : ''}>${s}</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        <select onchange="updateMovimento('${mov.id}', 'destinatario', this.value)" ${!needsDest ? 'disabled style="opacity:0.4"' : ''}>
                            <option value="Frank" ${mov.destinatario === 'Frank' ? 'selected' : ''}>Frank</option>
                            <option value="Fox" ${mov.destinatario === 'Fox' ? 'selected' : ''}>Fox</option>
                        </select>
                    </td>
                    <td>
                        <select onchange="updateMovimento('${mov.id}', 'lavoroCollegato', this.value)">
                            ${lavSelect}
                        </select>
                    </td>
                    <td><input type="text" value="${mov.causale || ''}" onchange="updateMovimento('${mov.id}', 'causale', this.value)"></td>
                    <td><input type="text" value="${mov.note || ''}" onchange="updateMovimento('${mov.id}', 'note', this.value)"></td>
                    <td><button class="delete-btn" onclick="deleteMovimento('${mov.id}')">Elimina</button></td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('movTotaleEntrate').innerHTML =
                `<span class="positive">Entrate: ${formatEuro(totEntrate)}</span> &nbsp; <span class="negative">Uscite: ${formatEuro(totUscite)}</span>`;
        }

        // Pagination - Movimenti
        function changeMovimentiPerPagina() {
            movimentiPerPage = parseInt(document.getElementById('movimentiPerPagina').value);
            movimentiPage = 1;
            renderMovimenti();
        }
        function prevPageMovimenti() { if (movimentiPage > 1) { movimentiPage--; renderMovimenti(); } }
        function nextPageMovimenti() {
            const total = Math.ceil(data.movimentiBancari.length / movimentiPerPage);
            if (movimentiPage < total) { movimentiPage++; renderMovimenti(); }
        }

        // =============== CONTO BANCARIO ===============
        function calculateBankBalance() {
            let saldo = 0;
            data.movimentiBancari.forEach(mov => {
                const importo = Math.abs(parseFloat(mov.importo) || 0);
                if (ENTRATA_TYPES.includes(mov.tipo)) {
                    saldo += importo;
                } else if (USCITA_BANK_TYPES.includes(mov.tipo)) {
                    saldo -= importo;
                }
            });
            data.contoBancario.saldoAttuale = saldo;

            const el = document.getElementById('saldoAttuale');
            el.textContent = formatEuro(saldo);
            el.className = 'saldo-value ' + (saldo >= 0 ? 'positive' : 'negative');
        }

        // =============== SITUAZIONE SOCI ===============
        function calculatePortafoglio() {
            const frank = { entrate: 0, spese: 0, anticipi: 0, anticipiSospesi: 0, prelievi: 0 };
            const fox = { entrate: 0, spese: 0, anticipi: 0, anticipiSospesi: 0, prelievi: 0 };

            // Helper: get split from lavoro collegato, fallback 50/50
            function getMovSplit(mov) {
                if (mov.lavoroCollegato) {
                    const lav = data.lavori.find(l => l.id === mov.lavoroCollegato);
                    if (lav) return (parseFloat(lav.percentualeFrank) || 50) / 100;
                }
                return (parseFloat(mov.percentualeFrank) || 50) / 100;
            }

            data.movimentiBancari.forEach(mov => {
                const importo = Math.abs(parseFloat(mov.importo) || 0);
                const dest = mov.destinatario || '';
                const pctFrank = getMovSplit(mov);
                const pctFox = 1 - pctFrank;

                if (mov.tipo === 'Entrata') {
                    frank.entrate += importo * pctFrank;
                    fox.entrate += importo * pctFox;
                }
                else if (mov.tipo === 'Prelievo Socio') {
                    if (dest === 'Frank') frank.prelievi += importo;
                    else if (dest === 'Fox') fox.prelievi += importo;
                }
                else if (mov.tipo === 'Spesa' || mov.tipo === 'Tasse') {
                    frank.spese += importo * pctFrank;
                    fox.spese += importo * pctFox;
                }
            });

            // Spese di tasca dai lavori (soggetto Frank/Fox = pagato di tasca)
            data.lavori.forEach(lav => {
                const costi = parseFloat(lav.costi) || 0;
                const sogg = lav.soggetto || '';
                if (costi > 0 && (sogg === 'Frank' || sogg === 'Fox')) {
                    const pctF = (parseFloat(lav.percentualeFrank) || 50) / 100;
                    const pctX = 1 - pctF;
                    const conteggiato = lav.conteggiato !== false;
                    if (conteggiato) {
                        frank.spese += costi * pctF;
                        fox.spese += costi * pctX;
                        if (sogg === 'Frank') frank.anticipi += costi;
                        else fox.anticipi += costi;
                    } else {
                        if (sogg === 'Frank') frank.anticipiSospesi += costi;
                        else fox.anticipiSospesi += costi;
                    }
                }
            });

            const frankSpettanza = frank.entrate - frank.spese;
            const foxSpettanza = fox.entrate - fox.spese;
            const frankPuoPrelevare = frankSpettanza + frank.anticipi - frank.prelievi;
            const foxPuoPrelevare = foxSpettanza + fox.anticipi - fox.prelievi;

            document.getElementById('frankTotals').innerHTML = renderPartnerCard(frank, frankSpettanza, frankPuoPrelevare);
            document.getElementById('foxTotals').innerHTML = renderPartnerCard(fox, foxSpettanza, foxPuoPrelevare);
        }

        function renderPartnerCard(p, spettanza, puoPrelevare) {
            let html = `
                <div class="total-line"><span>Quota Entrate:</span><span class="positive">${formatEuro(p.entrate)}</span></div>
                <div class="total-line"><span>Quota Spese:</span><span class="negative">- ${formatEuro(p.spese)}</span></div>
                <div class="total-line" style="font-weight:bold; border-top:1px solid var(--border); padding-top:8px; margin-top:4px;">
                    <span>= Quota Spettante:</span><span>${formatEuro(spettanza)}</span></div>
                <div class="total-line" style="margin-top:8px;"><span>Gia Prelevato:</span><span class="negative">- ${formatEuro(p.prelievi)}</span></div>
                <div class="total-line"><span>Anticipi conteggiati:</span><span class="positive">+ ${formatEuro(p.anticipi)}</span></div>
            `;

            if (p.anticipiSospesi > 0) {
                html += `<div class="total-line"><span>Anticipi in sospeso:</span><span style="color: #ffc107;">\u23F3 ${formatEuro(p.anticipiSospesi)}</span></div>`;
            }

            if (puoPrelevare >= 0) {
                html += `<div class="total-line"><span>PUO' ANCORA PRELEVARE:</span><span class="positive">${formatEuro(puoPrelevare)}</span></div>`;
            } else {
                html += `<div class="total-line"><span>HA PRELEVATO IN ECCESSO:</span><span class="negative">${formatEuro(Math.abs(puoPrelevare))}</span></div>`;
            }

            return html;
        }

        // =============== SPESE FUTURE ===============
        function addSpesaFutura() {
            data.speseFuture.push({
                descrizione: '',
                importo: 0,
                dataPrevista: new Date().toISOString().split('T')[0],
                ricorrente: 'NO',
                frequenza: '-',
                note: ''
            });
            autoSave();
            renderSpeseFuture();
        }

        function updateSpesaFutura(index, field, value) {
            data.speseFuture[index][field] = value;
            if (field === 'ricorrente' && value === 'NO') data.speseFuture[index].frequenza = '-';
            autoSave();
            renderSpeseFuture();
        }

        function deleteSpesaFutura(index) {
            if (confirm('Eliminare questa spesa futura?')) {
                data.speseFuture.splice(index, 1);
                autoSave();
                renderSpeseFuture();
            }
        }

        function renderSpeseFuture() {
            const tbody = document.getElementById('speseFutureBody');
            tbody.innerHTML = '';
            let totale = 0;

            data.speseFuture.forEach((spesa, index) => {
                const importo = parseFloat(spesa.importo) || 0;
                totale += importo;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="text" value="${spesa.descrizione}" onchange="updateSpesaFutura(${index}, 'descrizione', this.value)"></td>
                    <td><input type="number" step="0.01" value="${spesa.importo}" onchange="updateSpesaFutura(${index}, 'importo', this.value)"></td>
                    <td><input type="date" value="${spesa.dataPrevista}" onchange="updateSpesaFutura(${index}, 'dataPrevista', this.value)"></td>
                    <td>
                        <select onchange="updateSpesaFutura(${index}, 'ricorrente', this.value)">
                            <option value="NO" ${spesa.ricorrente === 'NO' ? 'selected' : ''}>NO</option>
                            <option value="SI" ${spesa.ricorrente === 'SI' ? 'selected' : ''}>SI</option>
                        </select>
                    </td>
                    <td>
                        <select onchange="updateSpesaFutura(${index}, 'frequenza', this.value)" ${spesa.ricorrente === 'NO' ? 'disabled' : ''}>
                            <option value="-" ${spesa.frequenza === '-' ? 'selected' : ''}>-</option>
                            <option value="Mensile" ${spesa.frequenza === 'Mensile' ? 'selected' : ''}>Mensile</option>
                            <option value="Trimestrale" ${spesa.frequenza === 'Trimestrale' ? 'selected' : ''}>Trimestrale</option>
                            <option value="Semestrale" ${spesa.frequenza === 'Semestrale' ? 'selected' : ''}>Semestrale</option>
                            <option value="Annuale" ${spesa.frequenza === 'Annuale' ? 'selected' : ''}>Annuale</option>
                        </select>
                    </td>
                    <td><input type="text" value="${spesa.note}" onchange="updateSpesaFutura(${index}, 'note', this.value)"></td>
                    <td><button class="delete-btn" onclick="deleteSpesaFutura(${index})">Elimina</button></td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('totaleSpeseFuture').textContent = formatEuro(totale);
        }

        // =============== THEME ===============
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('light-mode', !isDarkMode);
            localStorage.setItem('dosAmigosTheme', isDarkMode ? 'dark' : 'light');
            document.getElementById('themeToggle').textContent = isDarkMode ? 'Light Mode' : 'Dark Mode';
        }

        // =============== EXPORT ===============
        function exportToExcel() {
            // Sheet 1: Lavori
            const lavoriData = [['Data', 'Cliente', 'Lavoro', 'Importo Previsto', 'Imp. Fisc. (67%)', 'Tasse Stim. (5%)', 'Costi', '% Frank', '% Fox', 'Soggetto', 'Conteggiato', 'Stato']];
            data.lavori.forEach(row => {
                const calc = calculateRow(row);
                const stato = getLavoroStato(row);
                const pctF = parseFloat(row.percentualeFrank) || 50;
                const pctX = Math.round((100 - pctF) * 100) / 100;
                const sogg = row.soggetto || 'Dos Amigos';
                const isDiTasca = (parseFloat(row.costi) || 0) > 0 && (sogg === 'Frank' || sogg === 'Fox');
                const conteggiato = isDiTasca ? (row.conteggiato !== false ? 'Si' : 'No') : '-';
                lavoriData.push([
                    row.data, row.cliente, row.lavoro, row.importoPrevisto,
                    calc.imponibile.toFixed(2), calc.tasse.toFixed(2),
                    row.costi, pctF, pctX, row.soggetto, conteggiato, stato.stato
                ]);
            });

            // Sheet 2: Movimenti
            const movData = [['Data', 'Tipo', 'Importo', 'Soggetto', 'Destinatario', 'Lavoro Collegato', 'Causale', 'Note']];
            data.movimentiBancari.forEach(mov => {
                const lavLabel = data.lavori.find(l => l.id === mov.lavoroCollegato);
                movData.push([
                    mov.data, mov.tipo, mov.importo, mov.soggetto, mov.destinatario,
                    lavLabel ? `${lavLabel.cliente} - ${lavLabel.lavoro}` : '',
                    mov.causale, mov.note
                ]);
            });

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(lavoriData), 'Lavori');
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(movData), 'Movimenti Bancari');
            XLSX.writeFile(wb, 'DosAmigos_Contabilita.xlsx');
        }

        function downloadBackup() {
            const backup = {
                data: data,
                exportDate: new Date().toISOString(),
                version: '2.0'
            };
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `DosAmigos_Backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // =============== UTILITIES ===============
        function formatEuro(n) {
            return '\u20AC ' + (parseFloat(n) || 0).toFixed(2);
        }

        function updateSyncStatus(type, message) {
            const el = document.getElementById('syncStatus');
            el.textContent = message;
            el.className = 'sync-status ' + type;
            if (type === 'success') {
                setTimeout(() => {
                    el.textContent = 'Sincronizzato';
                    el.className = 'sync-status';
                }, 2000);
            }
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('active', show);
        }

        // =============== INIT ===============
        window.onload = async function () {
            // Apply saved theme
            const savedTheme = localStorage.getItem('dosAmigosTheme');
            if (savedTheme === 'light') {
                isDarkMode = false;
                document.body.classList.add('light-mode');
                document.getElementById('themeToggle').textContent = 'Dark Mode';
            }

            // Check auth
            const isAuth = await checkAuth();
            if (isAuth) {
                document.getElementById('loginScreen').classList.add('hidden');
                loadData();
            }
        };
    </script>
</body>

</html>
