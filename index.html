<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta name="googlebot" content="noindex, nofollow">
    <title>Contabilit√† Dos Amigos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #000000;
            color: #ffffff;
            min-height: 100vh;
        }

        .header {
            background: #000000;
            border-bottom: 1px solid #333;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sync-status {
            background: rgba(216, 255, 54, 0.2);
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid #333;
            color: #D8FF36;
            font-size: 14px;
        }

        .sync-status.saving {
            animation: pulse 1s infinite;
        }

        .sync-status.error {
            background: rgba(255, 68, 68, 0.2);
            border-color: #ff4444;
            color: #ff4444;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        .controls {
            padding: 20px;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
        }

        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn {
            background: #D8FF36;
            color: #000000;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #c4e830;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        input,
        select {
            padding: 10px;
            background: #2a2a2a;
            color: #ffffff;
            border: 1px solid #444;
            border-radius: 6px;
            font-size: 14px;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #D8FF36;
        }

        .table-container {
            overflow-x: auto;
            padding: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #000000;
        }

        th {
            background: #1a1a1a;
            color: #D8FF36;
            padding: 15px 10px;
            text-align: left;
            font-weight: bold;
            border-bottom: 1px solid #444;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: #2a2a2a;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid #333;
        }

        tr:hover {
            background: #1a1a1a;
        }

        tr.distributed {
            background: rgba(0, 100, 0, 0.3) !important;
        }

        td input,
        td select {
            width: 100%;
            padding: 6px;
            background: #2a2a2a;
            color: #ffffff;
            border: 1px solid #444;
            border-radius: 4px;
        }

        td input:read-only {
            background: #1a1a1a;
            border-bottom: 1px solid #333;
        }

        .totals {
            background: #1a1a1a;
            padding: 30px;
            margin: 20px;
            border-radius: 12px;
            border: 1px solid #333;
        }

        .totals h2 {
            color: #D8FF36;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .total-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .total-card {
            background: #000000;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #333;
        }

        .total-card h3 {
            color: #D8FF36;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .total-line {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #333;
            color: #ffffff;
        }

        .total-line:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.3em;
            margin-top: 10px;
            padding-top: 15px;
            border-top: 1px solid #333;
        }

        .positive {
            color: #D8FF36;
        }

        .negative {
            color: #ff4444;
        }

        .delete-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .delete-btn:hover {
            background: #cc0000;
        }

        .note {
            background: #000000;
            padding: 15px;
            margin: 20px;
            border-radius: 8px;
            border: 1px solid #333;
            color: #ffffff;
        }

        .note strong {
            color: #D8FF36;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 10px;
            border: 1px solid #333;
            display: none;
            z-index: 1000;
        }

        .loading.active {
            display: block;
        }

        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-box {
            background: #1a1a1a;
            padding: 40px;
            border-radius: 20px;
            border: 1px solid #333;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-box h2 {
            color: #D8FF36;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .login-box input {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            background: #2a2a2a;
            border: 2px solid #444;
            border-radius: 8px;
            color: white;
            font-size: 16px;
        }

        .login-box input:focus {
            border-color: #D8FF36;
            outline: none;
        }

        .login-box button {
            width: 100%;
            padding: 15px;
            background: #D8FF36;
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-box button:hover {
            background: #c4e830;
            transform: translateY(-2px);
        }

        .login-error {
            color: #ff4444;
            margin-top: 15px;
            display: none;
        }

        .login-error.show {
            display: block;
        }
    </style>
</head>

<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <svg width="150" height="60" viewBox="0 0 800 200">
                <rect width="800" height="200" fill="#1a1a1a" />
                <circle cx="80" cy="60" r="35" fill="none" stroke="#D8FF36" stroke-width="6" />
                <circle cx="95" cy="45" r="28" fill="none" stroke="#D8FF36" stroke-width="5" />
                <path d="M 50 100 L 50 150 L 110 150 L 110 100" fill="white" />
                <circle cx="65" cy="120" r="6" fill="black" />
                <circle cx="95" cy="120" r="6" fill="black" />
                <rect x="55" y="130" width="50" height="3" fill="black" />

                <path
                    d="M 260 30 Q 260 15 275 15 L 325 15 Q 340 15 340 30 L 340 50 Q 340 35 325 35 L 300 35 L 300 80 Q 315 80 330 95 L 330 100 Q 315 85 300 85 L 270 85 Q 255 85 255 100 L 255 95 Q 270 80 285 80 L 285 35 L 275 35 Q 260 35 260 50 Z"
                    fill="white" stroke="#D8FF36" stroke-width="3" />
                <ellipse cx="300" cy="20" rx="15" ry="8" fill="#D8FF36" />

                <text x="420" y="80" font-family="Arial Black" font-size="60" fill="white" font-weight="bold">DOS</text>
                <text x="420" y="140" font-family="Arial Black" font-size="60" fill="white"
                    font-weight="bold">AMIGOS</text>
            </svg>

            <h2>üîê Accesso Riservato</h2>

            <form id="loginForm" onsubmit="handleLogin(event)">
                <input type="text" id="username" placeholder="Username" autocomplete="off" required>
                <input type="password" id="password" placeholder="Password" autocomplete="off" required>
                <button type="submit">Accedi</button>
            </form>

            <div class="login-error" id="loginError">
                ‚ùå Credenziali errate! Riprova.
            </div>
        </div>
    </div>

    <div class="loading" id="loading">
        <div style="color: #D8FF36; font-size: 20px;">‚è≥ Caricamento...</div>
    </div>

    <div class="header">
        <svg width="200" height="70" viewBox="0 0 800 200">
            <rect width="800" height="200" fill="black" />
            <circle cx="80" cy="60" r="35" fill="none" stroke="#D8FF36" stroke-width="6" />
            <circle cx="95" cy="45" r="28" fill="none" stroke="#D8FF36" stroke-width="5" />
            <path d="M 50 100 L 50 150 L 110 150 L 110 100" fill="white" />
            <circle cx="65" cy="120" r="6" fill="black" />
            <circle cx="95" cy="120" r="6" fill="black" />
            <rect x="55" y="130" width="50" height="3" fill="black" />
            <rect x="55" y="136" width="50" height="3" fill="black" />
            <rect x="55" y="142" width="50" height="3" fill="black" />

            <path
                d="M 260 30 Q 260 15 275 15 L 325 15 Q 340 15 340 30 L 340 50 Q 340 35 325 35 L 300 35 L 300 80 Q 315 80 330 95 L 330 100 Q 315 85 300 85 L 270 85 Q 255 85 255 100 L 255 95 Q 270 80 285 80 L 285 35 L 275 35 Q 260 35 260 50 Z"
                fill="white" stroke="#D8FF36" stroke-width="3" />
            <ellipse cx="300" cy="20" rx="15" ry="8" fill="#D8FF36" />

            <text x="420" y="80" font-family="Arial Black" font-size="60" fill="white" font-weight="bold">DOS</text>
            <text x="420" y="140" font-family="Arial Black" font-size="60" fill="white" font-weight="bold">AMIGOS</text>
        </svg>

        <div class="sync-status" id="syncStatus">
            ‚òÅÔ∏è Sincronizzato con server
        </div>
    </div>

    <div class="container">
        <div class="controls">
            <div class="btn-group">
                <button class="btn" onclick="addRow()">‚ûï Aggiungi Riga</button>
                <button class="btn" onclick="exportToExcel()">üì• Esporta Excel</button>
                <button class="btn" onclick="manualSave()">üíæ Salva Ora</button>
                <button class="btn" onclick="downloadBackup()">üì¶ Download Backup</button>
                <button class="btn" onclick="logout()" style="background: #ff4444;">üö™ Logout</button>
            </div>

            <div class="filters">
                <input type="date" id="filterDateFrom" placeholder="Data da" onchange="applyFilters()">
                <input type="date" id="filterDateTo" placeholder="Data a" onchange="applyFilters()">
                <input type="text" id="filterCliente" placeholder="üîç Cerca cliente" onchange="applyFilters()">
                <input type="number" id="filterMinImporto" placeholder="Min ‚Ç¨" onchange="applyFilters()">
                <input type="number" id="filterMaxImporto" placeholder="Max ‚Ç¨" onchange="applyFilters()">
                <label
                    style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; background: #2a2a2a; border: 1px solid #444; border-radius: 6px;">
                    <input type="checkbox" id="hideDistributed" onchange="applyFilters()" checked
                        style="width: auto; cursor: pointer;">
                    <span>Nascondi distribuite</span>
                </label>
            </div>

            <!-- Paginazione Lavori -->
            <div
                style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: #1a1a1a; border-bottom: 1px solid #333;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span style="color: #D8FF36;">Mostra:</span>
                    <select id="lavoriPerPagina" onchange="changeLavoriPerPagina()"
                        style="padding: 8px; background: #2a2a2a; color: white; border: 1px solid #444; border-radius: 6px;">
                        <option value="10">10</option>
                        <option value="20" selected>20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    <span style="color: #999;">record per pagina</span>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button onclick="prevPageLavori()" class="btn" style="padding: 8px 16px;">‚óÄ Prec</button>
                    <span style="color: #D8FF36;" id="lavoriPaginaInfo">Pagina 1 di 1</span>
                    <button onclick="nextPageLavori()" class="btn" style="padding: 8px 16px;">Succ ‚ñ∂</button>
                </div>
            </div>
        </div>

        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th onclick="sortTable('data')">üìÖ Data ‚¨ç</th>
                        <th onclick="sortTable('cliente')">Cliente ‚¨ç</th>
                        <th>Lavoro / Spesa</th>
                        <th onclick="sortTable('incassato')">Incassato ‚¨ç</th>
                        <th>Imponibile Fisc. (67%)</th>
                        <th>Tasse (5%)</th>
                        <th onclick="sortTable('costi')">Costi ‚¨ç</th>
                        <th>Netto incassato</th>
                        <th>Netto per socio</th>
                        <th>Soggetto</th>
                        <th>Distribuito</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
                <tfoot>
                    <tr style="background: #1a1a1a; border-top: 1px solid #333;">
                        <td colspan="3" style="color: #D8FF36; font-weight: bold; font-size: 1.1em; padding: 15px;">
                            TOTALI</td>
                        <td style="color: #D8FF36; font-weight: bold; font-size: 1.1em;" id="totalIncassato">‚Ç¨ 0.00</td>
                        <td></td>
                        <td style="color: #ff4444; font-weight: bold; font-size: 1.1em;" id="totalTasse">‚Ç¨ 0.00</td>
                        <td style="color: #ff4444; font-weight: bold; font-size: 1.1em;" id="totalCosti">‚Ç¨ 0.00</td>
                        <td style="color: #D8FF36; font-weight: bold; font-size: 1.1em;" id="totalNetto">‚Ç¨ 0.00</td>
                        <td colspan="4"></td>
                    </tr>
                </tfoot>
            </table>
        </div>

    </div>

    <!-- Sezione Movimenti Bancari -->
    <div class="totals">
        <h2>üè¶ Movimenti Bancari</h2>
        <button class="btn" onclick="addMovimento()" style="margin-bottom: 15px;">‚ûï Aggiungi Movimento</button>

        <!-- Paginazione Movimenti Bancari -->
        <div
            style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; margin-bottom: 15px;">
            <div style="display: flex; gap: 10px; align-items: center;">
                <span style="color: #D8FF36;">Mostra:</span>
                <select id="movimentiPerPagina" onchange="changeMovimentiPerPagina()"
                    style="padding: 8px; background: #2a2a2a; color: white; border: 1px solid #444; border-radius: 6px;">
                    <option value="10">10</option>
                    <option value="20" selected>20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
                <span style="color: #999;">movimenti per pagina</span>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button onclick="prevPageMovimenti()" class="btn" style="padding: 8px 16px;">‚óÄ Prec</button>
                <span style="color: #D8FF36;" id="movimentiPaginaInfo">Pagina 1 di 1</span>
                <button onclick="nextPageMovimenti()" class="btn" style="padding: 8px 16px;">Succ ‚ñ∂</button>
            </div>
        </div>

        <div class="table-container" style="padding: 0;">
            <table>
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Tipo</th>
                        <th>Importo ‚Ç¨</th>
                        <th>Destinatario/Socio</th>
                        <th>Cliente</th>
                        <th>Causale</th>
                        <th>Note</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody id="movimentiBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Sezione Conto Bancario -->
    <div class="totals">
        <h2>üí≥ Conto Bancario Dos Amigos</h2>
        <div style="font-size: 2em; font-weight: bold; margin: 20px 0;">
            Saldo attuale: <span id="saldoAttuale" class="positive">‚Ç¨ 0.00</span>
        </div>
        <p style="color: #999; font-size: 0.9em;">Il saldo si aggiorna automaticamente con i movimenti bancari</p>
    </div>

    <div class="totals">
        <h2>üìä Portafoglio Soci (Avanzo/Debito)</h2>
        <div class="total-grid">
            <div class="total-card">
                <h3>ü¶ä FRANK</h3>
                <div id="frankTotals"></div>
            </div>
            <div class="total-card">
                <h3>ü¶ä FOX</h3>
                <div id="foxTotals"></div>
            </div>
        </div>
    </div>

    <!-- Sezione Spese Future -->
    <div class="totals">
        <h2>üìÖ Spese Future Pianificate</h2>
        <button class="btn" onclick="addSpesaFutura()" style="margin-bottom: 15px;">‚ûï Aggiungi Spesa</button>

        <div class="table-container" style="padding: 0;">
            <table>
                <thead>
                    <tr>
                        <th>Descrizione</th>
                        <th>Importo ‚Ç¨</th>
                        <th>Data Prevista</th>
                        <th>Ricorrente</th>
                        <th>Frequenza</th>
                        <th>Note</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody id="speseFutureBody"></tbody>
            </table>
        </div>

        <div
            style="margin-top: 20px; padding: 15px; background: rgba(255, 68, 68, 0.1); border: 2px solid #ff4444; border-radius: 8px;">
            <strong style="color: #ff4444;">Totale Spese Future:</strong>
            <span id="totaleSpeseFuture" style="font-size: 1.5em; color: #ff4444; margin-left: 10px;">‚Ç¨ 0.00</span>
        </div>
    </div>

    <div class="note">
        <strong>‚òÅÔ∏è Info:</strong> I dati vengono salvati automaticamente sul server ogni volta che modifichi qualcosa.
        Accessibile da qualsiasi dispositivo. I conteggi "Avanzo/Debito" per ogni socio riflettono quanto spetta loro
        dai lavori meno i bonifici gi√† ricevuti.
    </div>
    </div>

    <script>
        // ========== SISTEMA LOGIN SICURO (PHP) ==========
        const API_URL = 'api.php';

        async function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'login',
                        username: username,
                        password: password
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Login riuscito
                    document.getElementById('loginScreen').classList.add('hidden');
                    loadData();
                } else {
                    // Login fallito
                    showLoginError();
                }
            } catch (error) {
                console.error('Errore login:', error);
                showLoginError();
            }
        }

        function showLoginError() {
            document.getElementById('loginError').classList.add('show');
            document.getElementById('password').value = '';
            setTimeout(() => {
                document.getElementById('loginError').classList.remove('show');
            }, 3000);
        }

        async function checkAuth() {
            try {
                const response = await fetch(API_URL + '?action=check_auth');
                const result = await response.json();
                return result.authenticated;
            } catch (error) {
                return false;
            }
        }

        async function logout() {
            if (confirm('Vuoi disconnetterti?')) {
                await fetch(API_URL + '?action=logout');
                location.reload();
            }
        }

        // ========== SISTEMA CONTABILIT√Ä ==========
        let data = {
            lavori: [],
            movimentiBancari: [],
            contoBancario: { saldoAttuale: 0, storico: [] },
            speseFuture: []
        };
        let sortField = null;
        let sortDirection = 'asc';
        let saveTimeout = null;

        // Paginazione Lavori
        let lavoriPaginaCorrente = 1;
        let lavoriPerPagina = 20;

        // Paginazione Movimenti Bancari
        let movimentiPaginaCorrente = 1;
        let movimentiPerPagina = 20;

        // Carica dati all'avvio
        async function loadData() {
            showLoading(true);
            try {
                const response = await fetch(API_URL + '?action=load');
                const result = await response.json();

                if (result.success) {
                    data = result.data || getDefaultData();
                } else {
                    data = getDefaultData();
                }

                renderTable();
                updateSyncStatus('success', '‚òÅÔ∏è Dati caricati');
            } catch (error) {
                console.error('Errore caricamento:', error);
                data = getDefaultData();
                renderTable();
                updateSyncStatus('error', '‚ùå Errore caricamento');
            }
            showLoading(false);
        }

        function getDefaultData() {
            return {
                lavori: [],
                movimentiBancari: [],
                contoBancario: { saldoAttuale: 0, storico: [] },
                speseFuture: []
            };
        }

        async function saveData() {
            updateSyncStatus('saving', 'üíæ Salvataggio...');

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'save',
                        data: data
                    })
                });

                const result = await response.json();

                if (result.success) {
                    updateSyncStatus('success', '‚úÖ Salvato sul server');
                } else {
                    updateSyncStatus('error', '‚ùå Errore salvataggio');
                }
            } catch (error) {
                console.error('Errore salvataggio:', error);
                updateSyncStatus('error', '‚ùå Errore connessione');
            }
        }

        function autoSave() {
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                saveData();
            }, 1000);
        }

        function manualSave() {
            if (saveTimeout) clearTimeout(saveTimeout);
            saveData();
        }

        function updateSyncStatus(type, message) {
            const status = document.getElementById('syncStatus');
            status.textContent = message;
            status.className = 'sync-status ' + type;

            if (type === 'success') {
                setTimeout(() => {
                    status.textContent = '‚òÅÔ∏è Sincronizzato';
                    status.className = 'sync-status';
                }, 2000);
            }
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('active', show);
        }

        function calculateRow(row) {
            const incassato = parseFloat(row.incassato) || 0;
            const costi = parseFloat(row.costi) || 0;
            const imponibile = incassato * 0.67;
            const tasse = imponibile * 0.05;
            const netto = incassato - tasse - costi;
            const nettoPerSocio = row.soggetto === "Dos Amigos" ? netto / 2 : netto;

            return {
                imponibile: imponibile.toFixed(2),
                tasse: tasse.toFixed(2),
                netto: netto.toFixed(2),
                nettoPerSocio: nettoPerSocio.toFixed(2)
            };
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            const filtered = getFilteredData();

            filtered.forEach((row) => {
                const calc = calculateRow(row);
                const tr = document.createElement('tr');
                if (row.distribuito === 'SI') tr.classList.add('distributed');

                const originalIndex = data.lavori.indexOf(row);

                tr.innerHTML = `
                    <td><input type="date" value="${row.data}" onchange="updateData(${originalIndex}, 'data', this.value)"></td>
                    <td><input type="text" value="${row.cliente}" onchange="updateData(${originalIndex}, 'cliente', this.value)"></td>
                    <td><input type="text" value="${row.lavoro}" onchange="updateData(${originalIndex}, 'lavoro', this.value)"></td>
                    <td><input type="number" step="0.01" value="${row.incassato}" onchange="updateData(${originalIndex}, 'incassato', this.value)"></td>
                    <td><input type="text" value="${calc.imponibile}" readonly></td>
                    <td><input type="text" value="${calc.tasse}" readonly></td>
                    <td><input type="number" step="0.01" value="${row.costi}" onchange="updateData(${originalIndex}, 'costi', this.value)"></td>
                    <td><input type="text" value="${calc.netto}" readonly></td>
                    <td><input type="text" value="${calc.nettoPerSocio}" readonly></td>
                    <td>
                        <select onchange="updateData(${originalIndex}, 'soggetto', this.value)">
                            <option value="Dos Amigos" ${row.soggetto === "Dos Amigos" ? "selected" : ""}>Dos Amigos</option>
                            <option value="Frank" ${row.soggetto === "Frank" ? "selected" : ""}>Frank</option>
                            <option value="Fox" ${row.soggetto === "Fox" ? "selected" : ""}>Fox</option>
                        </select>
                    </td>
                    <td>
                        <select onchange="updateData(${originalIndex}, 'distribuito', this.value)">
                            <option value="NO" ${row.distribuito === "NO" ? "selected" : ""}>NO</option>
                            <option value="SI" ${row.distribuito === "SI" ? "selected" : ""}>SI</option>
                        </select>
                    </td>
                    <td><button class="delete-btn" onclick="deleteRow(${originalIndex})">üóëÔ∏è</button></td>
                `;

                tbody.appendChild(tr);
            });

            calculateTotals();
            renderMovimenti();
            renderContoBancario();
            renderSpeseFuture();
        }

        function updateData(index, field, value) {
            const oldValue = data.lavori[index][field];
            data.lavori[index][field] = value;

            // Auto-crea movimento bancario quando aggiungi/modifichi un incasso
            if (field === 'incassato') {
                const nuovoIncasso = parseFloat(value) || 0;
                const vecchioIncasso = parseFloat(oldValue) || 0;

                // Se passa da 0 a un valore > 0, crea movimento bancario
                if (vecchioIncasso === 0 && nuovoIncasso > 0) {
                    const lavoro = data.lavori[index];
                    data.movimentiBancari.push({
                        data: lavoro.data,
                        tipo: "Bonifico in entrata",
                        importo: nuovoIncasso,
                        destinatario: lavoro.soggetto,
                        cliente: lavoro.cliente,
                        causale: `Pagamento - ${lavoro.lavoro}`,
                        note: "Auto-generato da lavoro"
                    });
                    updateContoBancario();
                }
            }

            autoSave();
            renderTable();
        }

        function addRow() {
            const today = new Date().toISOString().split('T')[0];
            data.lavori.push({
                data: today,
                cliente: "",
                lavoro: "",
                incassato: 0,
                costi: 0,
                soggetto: "Dos Amigos",
                distribuito: "NO"
            });
            autoSave();
            renderTable();
        }

        function deleteRow(index) {
            if (confirm('Sei sicuro di voler eliminare questa riga?')) {
                data.lavori.splice(index, 1);
                autoSave();
                renderTable();
            }
        }

        function calculateTotals() {
            let frankIncassi = 0, frankRimborsi = 0;
            let foxIncassi = 0, foxRimborsi = 0;
            let dosAmigosIncassi = 0;
            let dosAmigosSpese = 0;
            let totaleTasse = 0;
            let totaleIncassato = 0;
            let totaleCosti = 0;
            let totaleNetto = 0;

            data.lavori.forEach(row => {
                if (row.distribuito === "NO") {
                    const incassato = parseFloat(row.incassato) || 0;
                    const costi = parseFloat(row.costi) || 0;
                    const imponibile = incassato * 0.67;
                    const tasse = imponibile * 0.05;
                    const netto = incassato - tasse - costi;

                    // Somma totali per la riga di riepilogo
                    totaleIncassato += incassato;
                    totaleTasse += tasse;
                    totaleCosti += costi;
                    totaleNetto += netto;

                    if (row.soggetto === "Dos Amigos") {
                        // Per Dos Amigos: somma incassi al netto tasse, somma spese
                        if (incassato > 0) {
                            dosAmigosIncassi += (incassato - tasse);
                        }
                        if (costi > 0) {
                            dosAmigosSpese += costi;
                        }
                    } else if (row.soggetto === "Frank") {
                        // Incassi personali Frank
                        if (incassato > 0) {
                            frankIncassi += (incassato - tasse - costi);
                        }
                        // Rimborsi Frank (spese anticipate)
                        if (costi > 0 && incassato === 0) {
                            frankRimborsi += costi;
                        }
                    } else if (row.soggetto === "Fox") {
                        // Incassi personali Fox
                        if (incassato > 0) {
                            foxIncassi += (incassato - tasse - costi);
                        }
                        // Rimborsi Fox (spese anticipate)
                        if (costi > 0 && incassato === 0) {
                            foxRimborsi += costi;
                        }
                    }
                }
            });

            // Calcola quanto i soci hanno gi√† PRESO dalla banca
            let frankGiaRicevuto = 0;
            let foxGiaRicevuto = 0;

            data.movimentiBancari.forEach(mov => {
                const importo = Math.abs(parseFloat(mov.importo) || 0);
                if (mov.tipo === "Bonifico in uscita" || mov.tipo === "Prelievo") {
                    if (mov.destinatario === "Frank") frankGiaRicevuto += importo;
                    if (mov.destinatario === "Fox") foxGiaRicevuto += importo;
                }
            });

            // Calcola netto Dos Amigos: sottrai spese comuni E rimborsi prima di dividere
            const dosAmigosNetto = dosAmigosIncassi - dosAmigosSpese - frankRimborsi - foxRimborsi;
            const frankQuota = dosAmigosNetto / 2;
            const foxQuota = dosAmigosNetto / 2;

            const frankSpettante = frankIncassi + frankRimborsi + frankQuota;
            const foxSpettante = foxIncassi + foxRimborsi + foxQuota;

            const frankBilancio = frankSpettante - frankGiaRicevuto;
            const foxBilancio = foxSpettante - foxGiaRicevuto;

            document.getElementById('frankTotals').innerHTML = `
                <div class="total-line"><span>Netto dai Lavori:</span><span class="positive">‚Ç¨ ${frankIncassi.toFixed(2)}</span></div>
                <div class="total-line"><span>Rimborsi Spese:</span><span class="positive">‚Ç¨ ${frankRimborsi.toFixed(2)}</span></div>
                <div class="total-line"><span>Quota Dos Amigos:</span><span class="${frankQuota >= 0 ? 'positive' : 'negative'}">‚Ç¨ ${frankQuota.toFixed(2)}</span></div>
                <div class="total-line" style="border-top: 1px dashed #444; margin-top: 5px;"><span>Totale Spettante:</span><span style="color: #fff">‚Ç¨ ${frankSpettante.toFixed(2)}</span></div>
                <div class="total-line"><span>Gi√† Ricevuto (Banca):</span><span class="negative">‚Ç¨ ${frankGiaRicevuto.toFixed(2)}</span></div>
                <div class="total-line"><span>AVANZO / DEBITO:</span><span class="${frankBilancio >= 0 ? 'positive' : 'negative'}">‚Ç¨ ${frankBilancio.toFixed(2)}</span></div>
            `;

            document.getElementById('foxTotals').innerHTML = `
                <div class="total-line"><span>Netto dai Lavori:</span><span class="positive">‚Ç¨ ${foxIncassi.toFixed(2)}</span></div>
                <div class="total-line"><span>Rimborsi Spese:</span><span class="positive">‚Ç¨ ${foxRimborsi.toFixed(2)}</span></div>
                <div class="total-line"><span>Quota Dos Amigos:</span><span class="${foxQuota >= 0 ? 'positive' : 'negative'}">‚Ç¨ ${foxQuota.toFixed(2)}</span></div>
                <div class="total-line" style="border-top: 1px dashed #444; margin-top: 5px;"><span>Totale Spettante:</span><span style="color: #fff">‚Ç¨ ${foxSpettante.toFixed(2)}</span></div>
                <div class="total-line"><span>Gi√† Ricevuto (Banca):</span><span class="negative">‚Ç¨ ${foxGiaRicevuto.toFixed(2)}</span></div>
                <div class="total-line"><span>AVANZO / DEBITO:</span><span class="${foxBilancio >= 0 ? 'positive' : 'negative'}">‚Ç¨ ${foxBilancio.toFixed(2)}</span></div>
            `;

            // Aggiorna riga totali in fondo alla tabella
            document.getElementById('totalIncassato').textContent = `‚Ç¨ ${totaleIncassato.toFixed(2)}`;
            document.getElementById('totalTasse').textContent = `‚Ç¨ ${totaleTasse.toFixed(2)}`;
            document.getElementById('totalCosti').textContent = `‚Ç¨ ${totaleCosti.toFixed(2)}`;
            document.getElementById('totalNetto').textContent = `‚Ç¨ ${totaleNetto.toFixed(2)}`;
        }

        function getFilteredData() {
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;
            const cliente = document.getElementById('filterCliente').value.toLowerCase();
            const minImporto = parseFloat(document.getElementById('filterMinImporto').value) || -Infinity;
            const maxImporto = parseFloat(document.getElementById('filterMaxImporto').value) || Infinity;
            const hideDistributed = document.getElementById('hideDistributed').checked;

            const filtered = data.lavori.filter(row => {
                if (dateFrom && row.data < dateFrom) return false;
                if (dateTo && row.data > dateTo) return false;
                if (cliente && !row.cliente.toLowerCase().includes(cliente)) return false;
                const inc = parseFloat(row.incassato) || 0;
                if (inc < minImporto || inc > maxImporto) return false;
                if (hideDistributed && row.distribuito === "SI") return false;
                return true;
            });

            // Paginazione
            const totalPages = Math.ceil(filtered.length / lavoriPerPagina);
            const start = (lavoriPaginaCorrente - 1) * lavoriPerPagina;
            const end = start + lavoriPerPagina;

            // Aggiorna info paginazione
            document.getElementById('lavoriPaginaInfo').textContent = `Pagina ${lavoriPaginaCorrente} di ${totalPages || 1} (${filtered.length} record)`;

            return filtered.slice(start, end);
        }

        function applyFilters() {
            lavoriPaginaCorrente = 1; // Reset alla prima pagina quando si applicano filtri
            renderTable();
        }

        function changeLavoriPerPagina() {
            lavoriPerPagina = parseInt(document.getElementById('lavoriPerPagina').value);
            lavoriPaginaCorrente = 1;
            renderTable();
        }

        function prevPageLavori() {
            if (lavoriPaginaCorrente > 1) {
                lavoriPaginaCorrente--;
                renderTable();
            }
        }

        function nextPageLavori() {
            const filtered = data.lavori.filter(row => {
                const dateFrom = document.getElementById('filterDateFrom').value;
                const dateTo = document.getElementById('filterDateTo').value;
                const cliente = document.getElementById('filterCliente').value.toLowerCase();
                const minImporto = parseFloat(document.getElementById('filterMinImporto').value) || -Infinity;
                const maxImporto = parseFloat(document.getElementById('filterMaxImporto').value) || Infinity;
                const hideDistributed = document.getElementById('hideDistributed').checked;

                if (dateFrom && row.data < dateFrom) return false;
                if (dateTo && row.data > dateTo) return false;
                if (cliente && !row.cliente.toLowerCase().includes(cliente)) return false;
                const inc = parseFloat(row.incassato) || 0;
                if (inc < minImporto || inc > maxImporto) return false;
                if (hideDistributed && row.distribuito === "SI") return false;
                return true;
            });

            const totalPages = Math.ceil(filtered.length / lavoriPerPagina);
            if (lavoriPaginaCorrente < totalPages) {
                lavoriPaginaCorrente++;
                renderTable();
            }
        }

        function sortTable(field) {
            if (sortField === field) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortDirection = 'asc';
            }

            data.lavori.sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];

                if (field === 'incassato' || field === 'costi') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                }

                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            autoSave();
            renderTable();
        }

        function exportToExcel() {
            const ws_data = [
                ["Data", "Cliente", "Lavoro / Spesa", "Incassato", "Imponibile Fisc. (67%)", "Tasse (5%)", "Costi", "Netto incassato", "Netto per socio", "Soggetto", "Distribuito"]
            ];

            data.lavori.forEach(row => {
                const calc = calculateRow(row);
                ws_data.push([
                    row.data, row.cliente, row.lavoro, row.incassato, calc.imponibile, calc.tasse,
                    row.costi, calc.netto, calc.nettoPerSocio, row.soggetto, row.distribuito
                ]);
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "Contabilit√†");
            XLSX.writeFile(wb, "DosAmigos_Contabilita.xlsx");
        }

        function downloadBackup() {
            const backup = {
                data: data,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };

            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `DosAmigos_Backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        // ========== MOVIMENTI BANCARI ==========
        function renderMovimenti() {
            const tbody = document.getElementById('movimentiBody');
            tbody.innerHTML = '';

            // Paginazione
            const totalMovimenti = data.movimentiBancari.length;
            const totalPages = Math.ceil(totalMovimenti / movimentiPerPagina);
            const start = (movimentiPaginaCorrente - 1) * movimentiPerPagina;
            const end = start + movimentiPerPagina;
            const movimentiPaginati = data.movimentiBancari.slice(start, end);

            // Aggiorna info paginazione
            document.getElementById('movimentiPaginaInfo').textContent = `Pagina ${movimentiPaginaCorrente} di ${totalPages || 1} (${totalMovimenti} record)`;

            movimentiPaginati.forEach((mov, paginaIndex) => {
                const index = start + paginaIndex; // Indice reale nell'array completo
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="date" value="${mov.data}" onchange="updateMovimento(${index}, 'data', this.value)"></td>
                    <td>
                        <select onchange="updateMovimento(${index}, 'tipo', this.value)">
                            <option value="Bonifico in entrata" ${mov.tipo === "Bonifico in entrata" ? "selected" : ""}>Bonifico in entrata</option>
                            <option value="Bonifico in uscita" ${mov.tipo === "Bonifico in uscita" ? "selected" : ""}>Bonifico in uscita</option>
                            <option value="Prelievo" ${mov.tipo === "Prelievo" ? "selected" : ""}>Prelievo</option>
                            <option value="Deposito" ${mov.tipo === "Deposito" ? "selected" : ""}>Deposito</option>
                            <option value="Tasse" ${mov.tipo === "Tasse" ? "selected" : ""}>Tasse</option>
                        </select>
                    </td>
                    <td><input type="number" step="0.01" value="${mov.importo}" onchange="updateMovimento(${index}, 'importo', this.value)"></td>
                    <td>
                        <select onchange="updateMovimento(${index}, 'destinatario', this.value)">
                            <option value="Frank" ${mov.destinatario === "Frank" ? "selected" : ""}>Frank</option>
                            <option value="Fox" ${mov.destinatario === "Fox" ? "selected" : ""}>Fox</option>
                            <option value="Dos Amigos" ${mov.destinatario === "Dos Amigos" ? "selected" : ""}>Dos Amigos</option>
                            <option value="Altro" ${mov.destinatario === "Altro" ? "selected" : ""}>Altro</option>
                        </select>
                    </td>
                    <td><input type="text" value="${mov.cliente || ''}" onchange="updateMovimento(${index}, 'cliente', this.value)"></td>
                    <td><input type="text" value="${mov.causale}" onchange="updateMovimento(${index}, 'causale', this.value)"></td>
                    <td><input type="text" value="${mov.note}" onchange="updateMovimento(${index}, 'note', this.value)"></td>
                    <td><button class="delete-btn" onclick="deleteMovimento(${index})">üóëÔ∏è</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function addMovimento() {
            const today = new Date().toISOString().split('T')[0];
            data.movimentiBancari.push({
                data: today,
                tipo: "Bonifico in uscita",
                importo: 0,
                destinatario: "Frank",
                cliente: "",
                causale: "",
                note: ""
            });
            autoSave();
            renderMovimenti();
            updateContoBancario();
        }

        function updateMovimento(index, field, value) {
            const oldImporto = parseFloat(data.movimentiBancari[index].importo) || 0;
            data.movimentiBancari[index][field] = value;

            // Se cambia l'importo, aggiorna il conto bancario
            if (field === 'importo' || field === 'tipo') {
                updateContoBancario();
            }

            autoSave();
            renderMovimenti();
        }

        function deleteMovimento(index) {
            if (confirm('Sei sicuro di voler eliminare questo movimento?')) {
                data.movimentiBancari.splice(index, 1);
                autoSave();
                renderMovimenti();
                updateContoBancario();
            }
        }

        function changeMovimentiPerPagina() {
            movimentiPerPagina = parseInt(document.getElementById('movimentiPerPagina').value);
            movimentiPaginaCorrente = 1;
            renderMovimenti();
        }

        function prevPageMovimenti() {
            if (movimentiPaginaCorrente > 1) {
                movimentiPaginaCorrente--;
                renderMovimenti();
            }
        }

        function nextPageMovimenti() {
            const totalPages = Math.ceil(data.movimentiBancari.length / movimentiPerPagina);
            if (movimentiPaginaCorrente < totalPages) {
                movimentiPaginaCorrente++;
                renderMovimenti();
            }
        }

        // ========== CONTO BANCARIO ==========
        function updateContoBancario() {
            // Calcola saldo dai movimenti
            let saldo = 0;
            data.movimentiBancari.forEach(mov => {
                const importo = parseFloat(mov.importo) || 0;
                // Bonifici in entrata e depositi sono positivi
                if (mov.tipo === "Bonifico in entrata" || mov.tipo === "Deposito") {
                    saldo += Math.abs(importo);
                } else {
                    // Bonifici in uscita, prelievi e tasse sono negativi
                    saldo -= Math.abs(importo);
                }
            });

            data.contoBancario.saldoAttuale = saldo;
            renderContoBancario();
        }

        function renderContoBancario() {
            const saldo = data.contoBancario.saldoAttuale;
            const saldoEl = document.getElementById('saldoAttuale');
            if (saldoEl) {
                saldoEl.textContent = `‚Ç¨ ${saldo.toFixed(2)}`;
                saldoEl.className = saldo >= 0 ? 'positive' : 'negative';
            }
        }

        // ========== SPESE FUTURE ==========
        function renderSpeseFuture() {
            const tbody = document.getElementById('speseFutureBody');
            tbody.innerHTML = '';

            let totale = 0;

            data.speseFuture.forEach((spesa, index) => {
                const tr = document.createElement('tr');
                const importo = parseFloat(spesa.importo) || 0;
                totale += importo;

                tr.innerHTML = `
                    <td><input type="text" value="${spesa.descrizione}" onchange="updateSpesaFutura(${index}, 'descrizione', this.value)"></td>
                    <td><input type="number" step="0.01" value="${spesa.importo}" onchange="updateSpesaFutura(${index}, 'importo', this.value)"></td>
                    <td><input type="date" value="${spesa.dataPrevista}" onchange="updateSpesaFutura(${index}, 'dataPrevista', this.value)"></td>
                    <td>
                        <select onchange="updateSpesaFutura(${index}, 'ricorrente', this.value)">
                            <option value="NO" ${spesa.ricorrente === "NO" ? "selected" : ""}>NO</option>
                            <option value="SI" ${spesa.ricorrente === "SI" ? "selected" : ""}>SI</option>
                        </select>
                    </td>
                    <td>
                        <select onchange="updateSpesaFutura(${index}, 'frequenza', this.value)" ${spesa.ricorrente === "NO" ? "disabled" : ""}>
                            <option value="-" ${spesa.frequenza === "-" ? "selected" : ""}>-</option>
                            <option value="Mensile" ${spesa.frequenza === "Mensile" ? "selected" : ""}>Mensile</option>
                            <option value="Trimestrale" ${spesa.frequenza === "Trimestrale" ? "selected" : ""}>Trimestrale</option>
                            <option value="Semestrale" ${spesa.frequenza === "Semestrale" ? "selected" : ""}>Semestrale</option>
                            <option value="Annuale" ${spesa.frequenza === "Annuale" ? "selected" : ""}>Annuale</option>
                        </select>
                    </td>
                    <td><input type="text" value="${spesa.note}" onchange="updateSpesaFutura(${index}, 'note', this.value)"></td>
                    <td><button class="delete-btn" onclick="deleteSpesaFutura(${index})">üóëÔ∏è</button></td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('totaleSpeseFuture').textContent = `‚Ç¨ ${totale.toFixed(2)}`;
        }

        function addSpesaFutura() {
            const today = new Date().toISOString().split('T')[0];
            data.speseFuture.push({
                descrizione: "",
                importo: 0,
                dataPrevista: today,
                ricorrente: "NO",
                frequenza: "-",
                note: ""
            });
            autoSave();
            renderSpeseFuture();
        }

        function updateSpesaFutura(index, field, value) {
            data.speseFuture[index][field] = value;

            // Se cambia ricorrente da SI a NO, resetta la frequenza
            if (field === 'ricorrente' && value === 'NO') {
                data.speseFuture[index].frequenza = '-';
            }

            autoSave();
            renderSpeseFuture();
        }

        function deleteSpesaFutura(index) {
            if (confirm('Sei sicuro di voler eliminare questa spesa futura?')) {
                data.speseFuture.splice(index, 1);
                autoSave();
                renderSpeseFuture();
            }
        }

        // Inizializzazione
        window.onload = async function () {
            // Controlla autenticazione
            const isAuth = await checkAuth();
            if (isAuth) {
                document.getElementById('loginScreen').classList.add('hidden');
                loadData();
            }
        };
    </script>
</body>

</html>